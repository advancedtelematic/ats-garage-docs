---
layout: page
title: "Your first OSTree-enabled Yocto project"
category: start-yocto
order: 1
date: 2017-01-16 18:02:25
---
:icons: font

To help new users get running with Yocto, we've created a quick-start project for the Raspberry Pi. In this tutorial, we'll show you:

* How to build your first Yocto image and get it running on a Raspberry Pi,
* How to automatically push that image to your ATS Garage account, and
* How to install the image on your Pi and get it talking to ATS Garage

== Prerequisites

* A linux machine with at least 50 GB of hard drive space and the link:http://www.yoctoproject.org/docs/current/yocto-project-qs/yocto-project-qs.html#packages[required software packages] from the Yocto project's Quickstart guide
* A link:https://www.raspberrypi.org/products/raspberry-pi-3-model-b/[Raspberry Pi 3]
* A micro SD card, 1 GB or larger
* An ATS Garage account with TreeHub enabled
* Your TreeHub credentials file (downloadable from the TreeHub tab in ATS Garage)

== Building your first Yocto image

Yocto is a set of tools for building your own linux distribution, from source. It's already the most common standard for commercial and industrial embedded systems, but it's also a great choice for dedicated hacking projects, because you can build in only what you need. The image you'll be building for this project, in fact, weighs in at just over 100 MB and boots in just a few seconds.

=== 1. Clone the ATS Garage Quickstart repo and set up your build environment

The link:https://github.com/advancedtelematic/garage-quickstart-rpi[garage-quickstart-rpi] project contains everything you need to get started. It uses git submodules, so make sure to use the `--recursive` option when you clone it:

----
git clone --recursive https://github.com/advancedtelematic/garage-quickstart-rpi.git
----

Then, enter the garage-quickstart-rpi directory and run the build setup script:

----
cd garage-quickstart-rpi
source env-init.sh
----

=== 2. Add your Treehub credentials to the build

The `meta-updater` layer will automatically push your images to TreeHub and add them to your ATS Garage account as part of the build process. To do that, it needs the credentials file you downloaded. (If you haven't downloaded it yet, grab it now from the link:https://app.atsgarage.com/#/treehub[TreeHub tab].)

Add this line to `garage-quickstart-rpi/build/conf/local.conf`, with your credentials file substituted in:

----
OSTREE_PUSH_CREDENTIALS = "path/to/credentials_file"
----

=== 3. Build your image

This part's easy. From the build directory, run

----
bitbake rpi-basic-image
----

image::http://imgs.xkcd.com/comics/compiling.png[float="left",align="center"]

Your first build will take a long time.

Yocto downloads source code, and builds absolutely everything from source. Naturally, this takes quite a while--anywhere from 45 minutes on a fast i7 to 2-3 hours or more on a slower system. Fortunately, Yocto does cache everything, so on subsequent builds you only need to recompile the pieces you've actually changed, which means everything goes much, much faster.

=== 4. Flash the image onto your micro SD card

For this step, you'll need to create a device in ATS Garage. Once you've done so, you can download a configuration file for your device from the device page. It should be named something like `sota_client_5206671b-cc2a-42e8-9227-736588bf6cf0.toml`, with a UUID unique to your device.

Now you can flash the image. We've included a script that does it for you, because there are a couple of extra steps:

----
sudo ../flash-configured-image.sh ./tmp/deploy/images/raspberrypi3/core-image-minimal-raspberrypi3.rpi-sdimg-ota /path/to/your/sota_client.toml /dev/sdX <1>
----
<1> Make sure the path to your sota_client.toml file and the correct block device for your micro SD card are substituted in.

.Alternative: manual steps
****
If you prefer to do the steps manually, you can do the following:

----
sudo dd if=./tmp/deploy/images/raspberrypi3/core-image-minimal-raspberrypi3.rpi-sdimg-ota \
  of=/dev/sdX bs=32M && sync
sudo parted -s /dev/sdX resizepart 2 '100%' <1>
sudo resize2fs /dev/sdX2 <1>
----
<1> The image file Yocto generates is shrunk down to the smallest it can be. After writing it to your SD card, you'll want to expand the partition and root filesystem so they use the whole disk.

Next, mount your SD card's second partition, and copy your `sota_client_UUID.toml` to `/boot/sota.toml`. It needs to be in exactly this location.
****

=== 5. Boot up your Raspberry Pi

Plug in an ethernet cable, insert the SD card you just flashed, and boot up your Pi. You should see it come online in ATS Garage momentarily.

== link:/ostree/making-your-first-ostree-update.html[Next: Pushing your first update >>]



